# java-webapi-lotto
---

# 구현 과정에서의 문제 발생 및 해결 보고서

구현 과정에서 겪은 주요 문제와 해결 과정을 정리했습니다.

---

## #1. JPA 1:1 연관 관계 저장 시 발생한 문제

### 1-1. 문제 상황

테스트 환경에서 Purchase(구매 내역) 객체를 생성하고, 이를 부모로 하는 BonusNumber, WinningLotto를 저장하는 코드에서 영속성 관련
문제가 발생했습니다.

### 1-2. 원인 분석

Purchase 객체를 먼저 repository.save를 통해 저장한 후, 이를 부모로 하는 BonusNumber 또는 WinningLotto를 추가적으로
저장하려했었습니다. 이때, Purchase 객체는 이미 트랜잭션이 끊겨 있는 상태에서, 준영속 상태가 되었습니다. 이후 준영속 상태인 이 객체를 재사용하여
자식 객체를 저장하려 했기 때문에, 문제가 발생했습니다.

### 1-3. 문제 해결

영속성 전이를 사용하여 이를 해결했습니다. Purchase 객체를 저장하지 않은 상태에서, 자식 클래스의 생성자에 주입 후, 자식 객체를 repository.save
를 통해 저장했습니다. 이를 통해, 자식 객체의 영속 상태를 Purchase 객체에게도 전이하여, 하나의 트랜젝션 내에서 처리하게 테스트 코드를 수정하여
해결할 수 있었습니다.

---

## #2. JPA 1:n 연관 관계 저장 시 발생한 문제

### 2-1. 문제 상황

테스트 환경에서 Purchase(구매 내역) 객체를 제거하고, 이를 부모로 하는 MyLotto를 제거하는 코드에서 무결성 관련 문제가 발생했습니다.

### 2-2. 원인 분석

Purchase 객체를 먼저 제거하는 코드를 작성 후, 이를 부모로 하는 MyLotto를 제거하려는 시도를 했을 때, MyLotto는 Purchase를 참조하고 있는
상태였기 때문에, 문제가 발생했습니다.

### 2-3. 문제 해결

올바른 제거 선후 관계로 코드를 다시 작성하여 이를 해결했습니다. 1:n 연관 관계에서의 자식 클래스를 먼저 제거한 후, 최종적으로 부모를 제거하도록
테스트 코드를 수정하여 해결할 수 있었습니다.

---

## #3. 로컬에서의 모든 테스트 실행 시 발생한 문제

### 3-1. 문제 상황

개별 테스트 코드에서는 잘 동작했던 테스트 코드가, 전체 테스트('gradlew test')를 실행할 때, 다수의 테스트가 실패했습니다.

### 3-2. 원인 분석

개별 테스트 코드는 해당 파일 내에서만 실행되는 반면, 전체 테스트 코드는 컨텍스트를 재사용하기 때문에, 기존 개별 테스트 코드에서 해당 테스트에서만
사용했던 Entity만을 삭제하면, 연관된 다른 Entity는 삭제되지 않기 때문에, 문제가 발생했습니다.

### 3-3. 문제 해결

모든 테스트 클래스의 @Beforeeach 작업에서, @Autowired를 통해, 모든 리포지토리 계층을 불러온 뒤, 개별 테스트 코드에서 사용하지 않은 Entity
또한 삭제해주는 로직을 추가하여 해결할 수 있었습니다.

---

## #4. CI 환경 내에서의 테스트 실행 시 발생한 문제

### 4-1. 문제 상황

로컬에서는 문제가 없이 모든 테스트를 통과할 수 있었지만, CI 환경 내에서는 다수의 테스트가 실패했습니다.

### 4-2. 원인 분석

로컬 개발 환경은 MySQL이 설치되어 있고, 초창기 CI 환경내에서는 아무것도 없는 빈 깡통이기 때문에, 관련 속성값을 CI 환경 내에서 불러올 수
없었기 때문에, 문제가 발생했습니다.

### 4-3. 문제 해결

CI 환경 내, MySql 컨테이너를 주입하는 로직을 추가하여, 관련 속성값의 부재로 발생했던 문제를 해결할 수 있었습니다.